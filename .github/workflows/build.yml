# Build Voice Manager
# Author: Sam Gu

name: Build Voice Manager

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download ffmpeg (static build)
        shell: pwsh
        run: |
          $url = "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip"
          Write-Host "Downloading ffmpeg..."
          Invoke-WebRequest -Uri $url -OutFile ffmpeg.zip
          Expand-Archive -Path ffmpeg.zip -DestinationPath ffmpeg-static -Force
          $bin = Get-ChildItem -Path ffmpeg-static -Recurse -Directory | Where-Object { $_.Name -eq "bin" } | Select-Object -First 1
          Write-Host "Found: $($bin.FullName)"
          Get-ChildItem $bin.FullName
          echo "FFMPEG_DIR=$($bin.FullName)" >> $env:GITHUB_ENV

      - name: Install dependencies
        run: pip install PyQt6 pilk pydub pyinstaller

      - name: Build
        shell: pwsh
        run: |
          $ffmpeg = "$env:FFMPEG_DIR\ffmpeg.exe"
          $ffprobe = "$env:FFMPEG_DIR\ffprobe.exe"
          Write-Host "ffmpeg source: $ffmpeg"
          if (-not (Test-Path $ffmpeg)) { Write-Error "ffmpeg not found"; exit 1 }

          pyinstaller --noconfirm --onedir --windowed --name "VoiceManager" `
            --add-binary "$ffmpeg;." --add-binary "$ffprobe;." `
            --hidden-import pilk --hidden-import pilk._pilk `
            --hidden-import pydub --hidden-import pydub.utils `
            --collect-all pilk voice_manager.py

          # PyInstaller 6.x 可能不会把binary放到根目录，手动复制确保存在
          $distRoot = "dist/VoiceManager"
          if (-not (Test-Path "$distRoot/ffmpeg.exe")) {
            Write-Host "Copying ffmpeg to dist root..."
            Copy-Item $ffmpeg "$distRoot/"
            Copy-Item $ffprobe "$distRoot/"
          }

      - name: Verify
        shell: pwsh
        run: |
          Write-Host "=== dist/VoiceManager contents ==="
          Get-ChildItem dist/VoiceManager/ | Format-Table Name, Length
          Write-Host "=== _internal contents ==="
          Get-ChildItem dist/VoiceManager/_internal/ -ErrorAction SilentlyContinue | Select-Object -First 20 | Format-Table Name, Length

          if (Test-Path "dist/VoiceManager/ffmpeg.exe") {
            $s = (Get-Item "dist/VoiceManager/ffmpeg.exe").Length / 1MB
            Write-Host "ffmpeg.exe: $([math]::Round($s,2)) MB"
            & "dist/VoiceManager/ffmpeg.exe" -version
          } else { Write-Error "ffmpeg NOT found in dist root"; exit 1 }

      - uses: actions/upload-artifact@v4
        with:
          name: VoiceManager-Windows
          path: dist/VoiceManager/

  build-macos:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install ffmpeg
        run: brew install ffmpeg

      - name: Install dependencies
        run: pip install PyQt6 pilk pydub pyinstaller

      - name: Build
        run: |
          FFMPEG=$(which ffmpeg)
          FFPROBE=$(which ffprobe)
          pyinstaller --noconfirm --onedir --windowed --name "VoiceManager" \
            --add-binary "$FFMPEG:Frameworks" --add-binary "$FFPROBE:Frameworks" \
            --hidden-import pilk --hidden-import pilk._pilk \
            --hidden-import pydub --hidden-import pydub.utils \
            --collect-all pilk --osx-bundle-identifier com.voicemanager.app \
            voice_manager.py

      - name: Verify
        run: |
          ls -la dist/VoiceManager.app/Contents/Frameworks/ || true
          if [ -f "dist/VoiceManager.app/Contents/Frameworks/ffmpeg" ]; then
            dist/VoiceManager.app/Contents/Frameworks/ffmpeg -version
          else
            echo "ERROR: ffmpeg NOT found"; exit 1
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: VoiceManager-macOS
          path: dist/VoiceManager.app/
