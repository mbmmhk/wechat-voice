name: Build Voice Manager

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install ffmpeg
        run: |
          choco install ffmpeg -y
          # 显示 ffmpeg 位置
          where ffmpeg
          ffmpeg -version

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyQt6 pilk pydub pyinstaller

      - name: Build with PyInstaller
        shell: pwsh
        run: |
          # 查找 ffmpeg 路径
          $ffmpegPath = (Get-Command ffmpeg).Source
          $ffprobePath = (Get-Command ffprobe).Source
          Write-Host "ffmpeg path: $ffmpegPath"
          Write-Host "ffprobe path: $ffprobePath"

          pyinstaller --noconfirm --onedir --windowed --name "VoiceManager" `
            --add-binary "$ffmpegPath;." `
            --add-binary "$ffprobePath;." `
            --hidden-import pilk `
            --hidden-import pilk._pilk `
            --hidden-import pydub `
            --hidden-import pydub.utils `
            --collect-all pilk `
            voice_manager.py

      - name: Verify build
        shell: pwsh
        run: |
          Write-Host "Build contents:"
          Get-ChildItem -Recurse dist/VoiceManager/ | Select-Object FullName
          Write-Host "Checking ffmpeg:"
          if (Test-Path "dist/VoiceManager/ffmpeg.exe") {
            Write-Host "ffmpeg.exe found!"
          } else {
            Write-Host "WARNING: ffmpeg.exe not found!"
          }

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: VoiceManager-Windows
          path: dist/VoiceManager/

  build-macos:
    runs-on: macos-13  # Intel Mac
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install ffmpeg
        run: |
          brew install ffmpeg
          which ffmpeg
          ffmpeg -version

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyQt6 pilk pydub pyinstaller

      - name: Build with PyInstaller
        run: |
          # 查找 ffmpeg 路径
          FFMPEG_PATH=$(which ffmpeg)
          FFPROBE_PATH=$(which ffprobe)
          echo "ffmpeg path: $FFMPEG_PATH"
          echo "ffprobe path: $FFPROBE_PATH"

          pyinstaller --noconfirm --onedir --windowed --name "VoiceManager" \
            --add-binary "$FFMPEG_PATH:Frameworks" \
            --add-binary "$FFPROBE_PATH:Frameworks" \
            --hidden-import pilk \
            --hidden-import pilk._pilk \
            --hidden-import pydub \
            --hidden-import pydub.utils \
            --collect-all pilk \
            --osx-bundle-identifier com.voicemanager.app \
            voice_manager.py

      - name: Verify and fix macOS App Bundle
        run: |
          echo "Build contents:"
          ls -la dist/

          # PyInstaller with --windowed on macOS creates .app automatically
          if [ -d "dist/VoiceManager.app" ]; then
            echo "App bundle created successfully"
            ls -la "dist/VoiceManager.app/Contents/"
            ls -la "dist/VoiceManager.app/Contents/MacOS/" || true
            ls -la "dist/VoiceManager.app/Contents/Frameworks/" || true
          else
            echo "ERROR: App bundle not created!"
            ls -la dist/
          fi

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: VoiceManager-macOS
          path: dist/VoiceManager.app/

  release:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create ZIP archives
        run: |
          cd VoiceManager-Windows && zip -r ../VoiceManager-Windows.zip . && cd ..
          cd VoiceManager-macOS && zip -r ../VoiceManager-macOS.zip . && cd ..

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            VoiceManager-Windows.zip
            VoiceManager-macOS.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
